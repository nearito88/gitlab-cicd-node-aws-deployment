# Définit l'image de base pour l'exécution des Jobs.
# Nous utilisons 'docker:dind' (Docker in Docker) pour construire des images Docker.
image: docker:latest
services:
  - docker:dind

# Variables Globales
variables:
  # L'URL du registre de conteneurs de GitLab.
  # C'est ici que ton image Docker sera stockée.
  CONTAINER_REGISTRY: $CI_REGISTRY
  # Le nom complet de l'image, basé sur le chemin du projet GitLab.
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  CONTAINER_IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# Définition des étapes du pipeline
stages:
  - build
  - test
  - deploy

###########################################################
# 1. ÉTAPE DE BUILD (CONSTRUCTION DE L'IMAGE DOCKER)
###########################################################
build_image:
  stage: build
  script:
    # 1. Connexion au registre de conteneurs de GitLab
    # $CI_REGISTRY_USER et $CI_REGISTRY_PASSWORD sont des variables intégrées de GitLab.
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    
    # 2. Construction de l'image Docker à partir du Dockerfile
    - docker build -t $CONTAINER_IMAGE .
    - docker tag $CONTAINER_IMAGE $CONTAINER_IMAGE_LATEST

    # 3. Poussée des deux tags vers le registre (latest et hash du commit)
    - docker push $CONTAINER_IMAGE
    - docker push $CONTAINER_IMAGE_LATEST
  
  # Le job s'exécute uniquement sur la branche principale ('main')
  only:
    - main

###########################################################
# 2. ÉTAPE DE TEST
###########################################################
unit_test:
  stage: test
  image: $CONTAINER_IMAGE_LATEST # Utilise l'image qui vient d'être construite
  script:
    # Ici, nous exécutons les tests définis dans package.json.
    # Pour l'exemple, c'est juste `echo "No tests specified"`.
    - npm test
    # Dans un vrai projet, nous aurions par exemple :
    # - npx jest

###########################################################
# 3. ÉTAPE DE DÉPLOIEMENT (VERS AWS EC2)
###########################################################
deploy_to_ec2:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - ssh-keyscan -H $EC2_HOST_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh -T $EC2_USER@$EC2_HOST_IP "
        echo 'Connected to EC2!'

        # Variables passed from GitLab CI
        CONTAINER_IMAGE_LATEST='registry.gitlab.com/nearito88/devops-p3/application:latest'
        CI_REGISTRY_USER='nearito88'
        CI_REGISTRY_PASSWORD='glpat-QN22yClyv02meJsZywJUwW86MQp1Omo3bDVuCw.01.120to8zr8'

        # Docker login
        echo \$CI_REGISTRY_PASSWORD | docker login -u \$CI_REGISTRY_USER --password-stdin

        # Pull the latest image
        docker pull \$CONTAINER_IMAGE_LATEST

        # Stop & remove old container if exists
        docker stop my-node-app || true
        docker rm my-node-app || true

        # Run the new container
        docker run -d --name my-node-app -p 80:3000 \$CONTAINER_IMAGE_LATEST
      "
  environment:
    name: production
    url: http://$EC2_HOST_IP
  only:
    - main